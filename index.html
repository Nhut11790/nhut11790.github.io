<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Tr√¨nh s·ª≠a MP3 Metadata</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/4.0.1/jsmediatags.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px 20px;
            max-width: 100%;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }
        
        .upload-section {
            margin-bottom: 20px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            display: block;
            padding: 15px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background 0.3s;
            -webkit-appearance: none;
            appearance: none;
            border: none;
            width: 100%;
        }
        
        .file-label:active {
            background: #5568d3;
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            text-align: center;
            word-break: break-word;
        }
        
        .metadata-section {
            display: none;
            margin-top: 20px;
        }
        
        .metadata-section.active {
            display: block;
        }
        
        .cover-preview {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .cover-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .no-cover {
            width: 120px;
            height: 120px;
            background: #f0f0f0;
            margin: 0 auto;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }
        
        .cover-button-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            justify-content: center;
        }
        
        .cover-button-group button {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-direction: column;
        }
        
        button {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:active {
            background: #5568d3;
            opacity: 0.8;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:active {
            background: #218838;
            opacity: 0.8;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:active {
            background: #e0e0e0;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:active {
            background: #c82333;
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            font-size: 13px;
            word-break: break-word;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ S·ª≠a MP3 Metadata</h1>
        
        <div class="upload-section">
            <label for="mp3File" class="file-label">üìÇ Ch·ªçn file MP3</label>
            <input type="file" id="mp3File" accept=".mp3">
            <div class="file-name" id="fileName"></div>
        </div>
        
        <div class="metadata-section" id="metadataSection">
            <div class="cover-preview">
                <div id="coverImage" class="no-cover">Kh√¥ng c√≥ ·∫£nh</div>
                <div class="cover-button-group">
                    <button class="btn-primary" onclick="document.getElementById('coverFile').click()" style="flex: 1; max-width: 100px;">Thay</button>
                    <button class="btn-danger" onclick="removeCover()" style="flex: 1; max-width: 100px;">X√≥a</button>
                </div>
            </div>
            
            <input type="file" id="coverFile" accept="image/*">
            
            <div class="form-group">
                <label for="title">T√™n b√†i</label>
                <input type="text" id="title" placeholder="Nh·∫≠p t√™n b√†i h√°t">
            </div>
            
            <div class="form-group">
                <label for="artist">Ngh·ªá sƒ©</label>
                <input type="text" id="artist" placeholder="Nh·∫≠p t√™n ngh·ªá sƒ©">
            </div>
            
            <div class="form-group">
                <label for="album">Album</label>
                <input type="text" id="album" placeholder="Nh·∫≠p t√™n album">
            </div>
            
            <div class="form-group">
                <label for="year">NƒÉm</label>
                <input type="text" id="year" placeholder="VD: 2024">
            </div>
            
            <div class="form-group">
                <label for="genre">Th·ªÉ lo·∫°i</label>
                <input type="text" id="genre" placeholder="Pop, Rock, Jazz...">
            </div>

            <div class="form-group">
                <label for="album_artist">Album Artist</label>
                <input type="text" id="album_artist" placeholder="Ngh·ªá sƒ© album">
            </div>

            <div class="form-group">
                <label for="track">Track</label>
                <input type="text" id="track" placeholder="VD: 1 ho·∫∑c 1/12">
            </div>
            
            <div class="form-group">
                <label for="comment">Ghi ch√∫</label>
                <textarea id="comment" placeholder="Th√™m ghi ch√∫..."></textarea>
            </div>
            
            <div class="button-group">
                <button class="btn-success" onclick="saveMp3()">üíæ L∆∞u & T·∫£i</button>
                <button class="btn-secondary" onclick="resetForm()">üîÑ L√†m m·ªõi</button>
            </div>
            
            <div class="message" id="message"></div>
        </div>
    </div>
    
    <script>
        let currentFile = null;
        let coverImageData = null;
        
        document.getElementById('mp3File').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'audio/mpeg') {
                currentFile = file;
                document.getElementById('fileName').textContent = `‚úì ${file.name}`;
                loadMetadata(file);
            } else {
                showMessage('Vui l√≤ng ch·ªçn file MP3', 'error');
            }
        });
        
        document.getElementById('coverFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    coverImageData = new Uint8Array(event.target.result);
                    const blob = new Blob([coverImageData]);
                    const url = URL.createObjectURL(blob);
                    document.getElementById('coverImage').innerHTML = `<img src="${url}">`;
                    showMessage('‚úì C·∫≠p nh·∫≠t ·∫£nh b√¨a', 'success');
                };
                reader.readAsArrayBuffer(file);
            }
        });
        
        function loadMetadata(file) {
            showMessage('‚è≥ ƒêang ƒë·ªçc...', 'info');
            
            jsmediatags.read(file, {
                onSuccess: function(tag) {
                    const tags = tag.tags;
                    document.getElementById('title').value = tags.title || '';
                    document.getElementById('artist').value = tags.artist || '';
                    document.getElementById('album').value = tags.album || '';
                    document.getElementById('year').value = tags.year || '';
                    document.getElementById('genre').value = tags.genre || '';
                    document.getElementById('album_artist').value = tags.albumartist || '';
                    document.getElementById('track').value = tags.track || '';
                    document.getElementById('comment').value = tags.comments || '';
                    
                    if (tags.picture) {
                        const pic = tags.picture;
                        const base64String = pic.data.map(i => String.fromCharCode(i)).join('');
                        const base64 = 'data:' + pic.format + ';base64,' + btoa(base64String);
                        document.getElementById('coverImage').innerHTML = `<img src="${base64}">`;
                    }
                    
                    document.getElementById('metadataSection').classList.add('active');
                    showMessage('‚úì T·∫£i th√†nh c√¥ng!', 'success');
                },
                onError: function(error) {
                    showMessage('‚ùå L·ªói: ' + error, 'error');
                }
            });
        }
        
        function saveMp3() {
            if (!currentFile) {
                showMessage('Vui l√≤ng ch·ªçn file MP3', 'error');
                return;
            }
            
            showMessage('üíæ ƒêang l∆∞u...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const buffer = e.target.result;
                    const modifiedBuffer = addID3Tags(buffer);
                    
                    // T·∫£i file
                    const blob = new Blob([modifiedBuffer], { type: 'audio/mpeg' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = currentFile.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    
                    showMessage('‚úì T·∫£i file th√†nh c√¥ng!', 'success');
                } catch (error) {
                    showMessage('‚ùå ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(currentFile);
        }
        
        function addID3Tags(buffer) {
            const title = document.getElementById('title').value;
            const artist = document.getElementById('artist').value;
            const album = document.getElementById('album').value;
            const year = document.getElementById('year').value;
            const genre = document.getElementById('genre').value;
            const track = document.getElementById('track').value;
            const comment = document.getElementById('comment').value;
            const albumArtist = document.getElementById('album_artist').value;
            
            let id3 = new Uint8Array(10);
            id3[0] = 0x49;
            id3[1] = 0x44;
            id3[2] = 0x33;
            id3[3] = 0x04;
            id3[4] = 0x00;
            id3[5] = 0x00;
            
            let frames = new Uint8Array();
            
            if (title) frames = concatArrays(frames, createTextFrame('TIT2', title));
            if (artist) frames = concatArrays(frames, createTextFrame('TPE1', artist));
            if (album) frames = concatArrays(frames, createTextFrame('TALB', album));
            if (year) frames = concatArrays(frames, createTextFrame('TYER', year));
            if (genre) frames = concatArrays(frames, createTextFrame('TCON', genre));
            if (track) frames = concatArrays(frames, createTextFrame('TRCK', track));
            if (albumArtist) frames = concatArrays(frames, createTextFrame('TPE2', albumArtist));
            if (comment) frames = concatArrays(frames, createTextFrame('COMM', comment));
            if (coverImageData) frames = concatArrays(frames, createPictureFrame(coverImageData));
            
            const tagSize = encodeSize(frames.length);
            id3[6] = tagSize[0];
            id3[7] = tagSize[1];
            id3[8] = tagSize[2];
            id3[9] = tagSize[3];
            
            let result = concatArrays(id3, frames);
            result = concatArrays(result, new Uint8Array(buffer));
            
            return result.buffer;
        }
        
        function createTextFrame(frameId, text) {
            const encoded = new TextEncoder().encode(text);
            const frameSize = encoded.length + 1;
            
            let frame = new Uint8Array(10 + frameSize);
            frame[0] = frameId.charCodeAt(0);
            frame[1] = frameId.charCodeAt(1);
            frame[2] = frameId.charCodeAt(2);
            frame[3] = frameId.charCodeAt(3);
            
            const size = encodeSize(frameSize);
            frame[4] = size[0];
            frame[5] = size[1];
            frame[6] = size[2];
            frame[7] = size[3];
            frame[8] = 0x00;
            frame[9] = 0x00;
            frame[10] = 0x03;
            
            for (let i = 0; i < encoded.length; i++) {
                frame[11 + i] = encoded[i];
            }
            
            return frame;
        }
        
        function createPictureFrame(imageData) {
            const desc = new TextEncoder().encode('Cover');
            const frameSize = 1 + 1 + 11 + 1 + desc.length + 1 + imageData.length;
            
            let frame = new Uint8Array(10 + frameSize);
            frame[0] = 0x50;
            frame[1] = 0x49;
            frame[2] = 0x43;
            
            const size = encodeSize(frameSize);
            frame[4] = size[0];
            frame[5] = size[1];
            frame[6] = size[2];
            frame[7] = size[3];
            frame[8] = 0x00;
            frame[9] = 0x00;
            frame[10] = 0x03;
            
            const mime = 'image/jpeg';
            let pos = 11;
            for (let i = 0; i < mime.length; i++) frame[pos++] = mime.charCodeAt(i);
            frame[pos++] = 0x00;
            frame[pos++] = 0x03;
            frame[pos++] = 0x00;
            
            for (let i = 0; i < imageData.length; i++) {
                frame[pos++] = imageData[i];
            }
            
            return frame;
        }
        
        function encodeSize(size) {
            return [(size >> 21) & 0x7F, (size >> 14) & 0x7F, (size >> 7) & 0x7F, size & 0x7F];
        }
        
        function concatArrays(arr1, arr2) {
            const result = new Uint8Array(arr1.length + arr2.length);
            result.set(arr1);
            result.set(arr2, arr1.length);
            return result;
        }
        
        function removeCover() {
            coverImageData = null;
            document.getElementById('coverImage').innerHTML = '<div class="no-cover">Kh√¥ng c√≥ ·∫£nh</div>';
            document.getElementById('coverFile').value = '';
            showMessage('‚úì ƒê√£ x√≥a ·∫£nh', 'success');
        }
        
        function resetForm() {
            document.getElementById('title').value = '';
            document.getElementById('artist').value = '';
            document.getElementById('album').value = '';
            document.getElementById('year').value = '';
            document.getElementById('genre').value = '';
            document.getElementById('album_artist').value = '';
            document.getElementById('track').value = '';
            document.getElementById('comment').value = '';
            document.getElementById('coverImage').innerHTML = '<div class="no-cover">Kh√¥ng c√≥ ·∫£nh</div>';
            document.getElementById('mp3File').value = '';
            document.getElementById('coverFile').value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('message').textContent = '';
            document.getElementById('metadataSection').classList.remove('active');
            coverImageData = null;
        }
        
        function showMessage(text, type) {
            const msgEl = document.getElementById('message');
            msgEl.innerHTML = text;
            msgEl.className = 'message ' + type;
        }
    </script>
</body>
</html>
