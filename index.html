<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ª•p ·∫¢nh v·ªõi V·ªã Tr√≠ v√† B·∫£n ƒê·ªì</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .camera-section, .map-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .camera-section {
            display: flex;
            flex-direction: column;
        }

        #video {
            width: 100%;
            height: 400px;
            background: #000;
            display: block;
            border-radius: 15px 15px 0 0;
        }

        #canvas {
            display: none;
        }

        .info-panel {
            padding: 20px;
            background: #f8f9fa;
            flex: 1;
        }

        .info-panel h2 {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-item {
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }

        .info-label {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
        }

        .info-value {
            color: #333;
            margin-top: 5px;
            word-break: break-all;
            font-size: 0.95em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: white;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 25px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #764ba2;
            color: white;
        }

        .btn-secondary:hover {
            background: #633a8a;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(118, 75, 162, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .map-section {
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            min-height: 400px;
            border-radius: 15px 15px 0 0;
        }

        .location-loading {
            text-align: center;
            padding: 30px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .captured-image {
            max-width: 100%;
            margin-top: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-error {
            background: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fca5a5;
        }

        .status-info {
            background: #dbeafe;
            color: #0c2d6b;
            border: 1px solid #93c5fd;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Ch·ª•p ·∫¢nh v·ªõi V·ªã Tr√≠ GPS</h1>
            <p>Ch·ª•p ·∫£nh v√† ghi l·∫°i th√¥ng tin v·ªã tr√≠ chi ti·∫øt</p>
        </div>

        <div class="main-content">
            <!-- Ph·∫ßn Camera -->
            <div class="camera-section">
                <video id="video" autoplay playsinline></video>
                <div class="info-panel">
                    <h2>üìπ Camera</h2>
                    <div id="status-message"></div>
                    <div id="captured-image-container"></div>
                </div>
            </div>

            <!-- Ph·∫ßn B·∫£n ƒê·ªì -->
            <div class="map-section">
                <div id="map"></div>
                <div class="info-panel">
                    <h2>üìç Th√¥ng Tin V·ªã Tr√≠</h2>
                    <div id="location-info">
                        <div class="location-loading">
                            <div class="spinner"></div>
                            <p>ƒêang l·∫•y v·ªã tr√≠ c·ªßa b·∫°n...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="btn-start-camera">üé• B·∫≠t Camera</button>
            <button class="btn-success" id="btn-capture" disabled>üì∑ Ch·ª•p ·∫¢nh</button>
            <button class="btn-secondary" id="btn-stop-camera" disabled>‚èπÔ∏è T·∫Øt Camera</button>
            <button class="btn-danger" id="btn-download">‚¨áÔ∏è T·∫£i ·∫¢nh</button>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <!-- Leaflet Map Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // ==================== GLOBAL VARIABLES ====================
        let stream = null;
        let currentLocation = null;
        let map = null;
        let marker = null;
        let capturedImageData = null;
        let currentDateTime = null;

        // ==================== CAMERA FUNCTIONS ====================
        async function startCamera() {
            try {
                const video = document.getElementById('video');
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                video.srcObject = stream;
                
                document.getElementById('btn-start-camera').disabled = true;
                document.getElementById('btn-capture').disabled = false;
                document.getElementById('btn-stop-camera').disabled = false;
                showStatus('Camera b·∫≠t th√†nh c√¥ng!', 'success');
            } catch (error) {
                showStatus('L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p camera. ' + error.message, 'error');
                console.error('Error accessing camera:', error);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('btn-start-camera').disabled = false;
            document.getElementById('btn-capture').disabled = true;
            document.getElementById('btn-stop-camera').disabled = true;
            showStatus('Camera ƒë√£ t·∫Øt', 'info');
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // V·∫Ω video frame
            ctx.drawImage(video, 0, canvas.width, canvas.height);

            // L·∫•y ·∫£nh
            capturedImageData = canvas.toDataURL('image/jpeg', 0.95);
            
            // Hi·ªÉn th·ªã ·∫£nh
            displayCapturedImage(capturedImageData);
            showStatus('ƒê√£ ch·ª•p ·∫£nh th√†nh c√¥ng!', 'success');
        }

        function displayCapturedImage(imageData) {
            const container = document.getElementById('captured-image-container');
            const img = document.createElement('img');
            img.src = imageData;
            img.class = 'captured-image';
            img.style.maxWidth = '100%';
            img.style.marginTop = '15px';
            img.style.borderRadius = '10px';
            img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            
            container.innerHTML = '';
            container.appendChild(img);
        }

        // ==================== LOCATION FUNCTIONS ====================
        async function getLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const coords = position.coords;
                            currentLocation = {
                                latitude: coords.latitude,
                                longitude: coords.longitude,
                                accuracy: coords.accuracy,
                                altitude: coords.altitude,
                                timestamp: position.timestamp
                            };
                            resolve(currentLocation);
                        },
                        (error) => {
                            reject(error);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    reject(new Error('Geolocation kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£'));
                }
            });
        }

        async function getReverseGeocoding(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                    {
                        headers: { 'Accept-Language': 'vi' }
                    }
                );
                const data = await response.json();
                return data.address || {};
            } catch (error) {
                console.error('Error reverse geocoding:', error);
                return {};
            }
        }

        async function updateLocationInfo() {
            try {
                const location = await getLocation();
                const address = await getReverseGeocoding(location.latitude, location.longitude);
                
                displayLocationInfo(location, address);
                initializeMap(location);
            } catch (error) {
                const infoDiv = document.getElementById('location-info');
                infoDiv.innerHTML = `
                    <div class="status-message status-error">
                        ‚ùå L·ªói: ${error.message}
                    </div>
                `;
                console.error('Error getting location:', error);
            }
        }

        function displayLocationInfo(location, address) {
            currentDateTime = new Date();
            
            const infoDiv = document.getElementById('location-info');
            const addressText = formatAddress(address);
            
            infoDiv.innerHTML = `
                <div class="info-item">
                    <div class="info-label">üìÖ Ng√†y Gi·ªù</div>
                    <div class="info-value">${formatDateTime(currentDateTime)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">üåê T·ªça ƒê·ªô</div>
                    <div class="info-value">
                        ${location.latitude.toFixed(6)}¬∞N<br>
                        ${location.longitude.toFixed(6)}¬∞E
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">üìç ƒê·ªãa Ch·ªâ</div>
                    <div class="info-value">${addressText || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ƒë·ªãa ch·ªâ'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">üéØ ƒê·ªô Ch√≠nh X√°c</div>
                    <div class="info-value">¬±${location.accuracy.toFixed(2)} m√©t</div>
                </div>
                ${location.altitude ? `
                <div class="info-item">
                    <div class="info-label">üìè ƒê·ªô Cao</div>
                    <div class="info-value">${location.altitude.toFixed(2)} m√©t</div>
                </div>
                ` : ''}
            `;
        }

        function formatAddress(address) {
            const parts = [];
            
            if (address.house_number) parts.push(address.house_number);
            if (address.road) parts.push(address.road);
            if (address.suburb) parts.push(address.suburb);
            if (address.city) parts.push(address.city);
            if (address.county) parts.push(address.county);
            if (address.state) parts.push(address.state);
            if (address.country) parts.push(address.country);
            
            return parts.join(', ') || 'Kh√¥ng x√°c ƒë·ªãnh';
        }

        function formatDateTime(date) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Ho_Chi_Minh'
            };
            return date.toLocaleString('vi-VN', options);
        }

        // ==================== MAP FUNCTIONS ====================
        function initializeMap(location) {
            if (map) {
                map.remove();
            }

            map = L.map('map').setView([location.latitude, location.longitude], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Th√™m marker
            marker = L.marker([location.latitude, location.longitude], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);

            // Th√™m circle hi·ªÉn th·ªã ƒë·ªô ch√≠nh x√°c
            L.circle([location.latitude, location.longitude], {
                radius: location.accuracy,
                color: '#667eea',
                fillColor: '#667eea',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);

            marker.bindPopup(`<b>V·ªã tr√≠ hi·ªán t·∫°i</b><br>Ch√≠nh x√°c: ¬±${location.accuracy.toFixed(2)}m`).openPopup();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            
            setTimeout(() => {
                statusDiv.textContent = '';
            }, 5000);
        }

        function downloadImage() {
            if (!capturedImageData || !currentLocation || !currentDateTime) {
                showStatus('Vui l√≤ng ch·ª•p ·∫£nh tr∆∞·ªõc khi t·∫£i xu·ªëng', 'error');
                return;
            }

            // T·∫°o canvas m·ªõi ƒë·ªÉ v·∫Ω ·∫£nh + th√¥ng tin
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height + 150;

                // V·∫Ω ·∫£nh
                ctx.drawImage(img, 0, 0);

                // V·∫Ω n·ªÅn cho th√¥ng tin
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, img.height, canvas.width, 150);

                // V·∫Ω text
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(`Ng√†y gi·ªù: ${formatDateTime(currentDateTime)}`, 20, img.height + 30);
                ctx.fillText(`T·ªça ƒë·ªô: ${currentLocation.latitude.toFixed(6)}¬∞N, ${currentLocation.longitude.toFixed(6)}¬∞E`, 20, img.height + 60);
                ctx.fillText(`ƒê·ªô ch√≠nh x√°c: ¬±${currentLocation.accuracy.toFixed(2)}m`, 20, img.height + 90);
                ctx.fillText(`ƒê·ªô cao: ${currentLocation.altitude?.toFixed(2) || 'N/A'}m`, 20, img.height + 120);

                // T·∫£i xu·ªëng
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.download = `photo_${new Date().getTime()}.jpg`;
                link.click();

                showStatus('·∫¢nh ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng!', 'success');
            };
            img.src = capturedImageData;
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('btn-start-camera').addEventListener('click', startCamera);
        document.getElementById('btn-capture').addEventListener('click', capturePhoto);
        document.getElementById('btn-stop-camera').addEventListener('click', stopCamera);
        document.getElementById('btn-download').addEventListener('click', downloadImage);

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            updateLocationInfo();
            
            // C·∫≠p nh·∫≠t v·ªã tr√≠ m·ªói 10 gi√¢y
            setInterval(updateLocationInfo, 10000);
        });
    </script>
</body>
</html>
