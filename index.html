<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>MP3 ID3 Editor — Chỉnh metadata & cover, tải về</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:980px;margin:24px auto;padding:0 18px;color:#111}
    h1{font-size:20px;margin-bottom:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;background:#fafafa}
    label{display:block;font-weight:600;margin-top:8px}
    input[type="text"], input[type="number"], textarea, select{width:100%;box-sizing:border-box;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0b79ff;color:white;cursor:pointer;font-weight:600}
    button:disabled{opacity:.5;cursor:not-allowed}
    #coverPreview{width:220px;height:220px;object-fit:cover;border-radius:6px;border:1px solid #ccc;display:block}
    .metaGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    small{color:#666}
    .foot{margin-top:14px;color:#444;font-size:13px}
    .actions{display:flex;gap:8px;align-items:center;margin-top:12px}
    .hint{background:#fff8e1;border:1px solid #ffe08a;padding:8px;border-radius:6px;margin-top:8px}
  </style>
</head>
<body>
  <h1>MP3 ID3 Editor — Chỉnh metadata & cover (trình duyệt)</h1>
  <div class="card">
    <label>Tải file MP3 lên</label>
    <input id="mp3File" type="file" accept=".mp3,audio/mpeg" />
    <div class="foot">Tệp MP3 sẽ được đọc trong trình duyệt — không upload ra server.</div>
  </div>

  <div id="editorArea" style="display:none;margin-top:14px">
    <div class="row">
      <div class="card" style="flex:1;min-width:320px">
        <strong>Metadata (sửa rồi nhấn "Áp dụng & Tải về")</strong>
        <div class="metaGrid" style="margin-top:10px">
          <div>
            <label>Tiêu đề (Title)</label>
            <input id="title" type="text" placeholder="Tiêu đề bài hát" />
          </div>
          <div>
            <label>Ca sĩ (Artist)</label>
            <input id="artist" type="text" placeholder="Ca sĩ / nghệ sĩ" />
          </div>
          <div>
            <label>Album</label>
            <input id="album" type="text" placeholder="Album" />
          </div>
          <div>
            <label>Năm (Year)</label>
            <input id="year" type="number" min="0" placeholder="2024" />
          </div>
        </div>

        <label>Thể loại (Genre)</label>
        <input id="genre" type="text" placeholder="Genre" />

        <label>Chú thích (Comment)</label>
        <textarea id="comment" rows="3" placeholder="Ghi chú / comment"></textarea>
      </div>

      <div class="card" style="width:260px;flex-shrink:0">
        <strong>Ảnh bìa (Cover)</strong>
        <div style="margin-top:8px">
          <img id="coverPreview" alt="Cover preview" src="" />
        </div>
        <label style="margin-top:8px">Thay ảnh (Upload)</label>
        <input id="coverFile" type="file" accept="image/*" />
        <div class="hint">
          <small>Khuyến nghị: 500×500 → 1400×1400 px, JPEG. Nếu quá lớn, trình sẽ tự resize để giảm dung lượng.</small>
        </div>
        <div style="margin-top:8px">
          <button id="removeCover">Xóa ảnh</button>
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="applyBtn" disabled>Áp dụng & Tải về MP3 đã sửa</button>
      <button id="previewBtn" disabled>Preview tags (console)</button>
      <div id="status" style="margin-left:8px;color:#333"></div>
    </div>
  </div>

  <script src="https://unpkg.com/jsmediatags@3.9.5/dist/jsmediatags.min.js"></script>
  <script src="https://unpkg.com/browser-id3-writer@4.0.0/dist/browser-id3-writer.min.js"></script>
  <script>
    // Element refs
    const mp3FileInput = document.getElementById('mp3File');
    const coverFileInput = document.getElementById('coverFile');
    const editorArea = document.getElementById('editorArea');
    const titleInput = document.getElementById('title');
    const artistInput = document.getElementById('artist');
    const albumInput = document.getElementById('album');
    const yearInput = document.getElementById('year');
    const genreInput = document.getElementById('genre');
    const commentInput = document.getElementById('comment');
    const coverPreview = document.getElementById('coverPreview');
    const applyBtn = document.getElementById('applyBtn');
    const previewBtn = document.getElementById('previewBtn');
    const statusEl = document.getElementById('status');
    const removeCoverBtn = document.getElementById('removeCover');

    let mp3File = null;
    let mp3ArrayBuffer = null;
    let currentCoverArrayBuffer = null; // ArrayBuffer for image
    let coverMime = null;

    // Utilities
    function setStatus(txt, isError=false){
      statusEl.textContent = txt || '';
      statusEl.style.color = isError ? '#b00020' : '#333';
    }

    function arrayBufferToDataURL(buffer, mime){
      const blob = new Blob([buffer], {type: mime || 'image/jpeg'});
      return URL.createObjectURL(blob);
    }

    function readFileAsArrayBuffer(file){
      return new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload = e => res(e.target.result);
        fr.onerror = e => rej(e);
        fr.readAsArrayBuffer(file);
      });
    }

    // Resize image with canvas to max dimension to limit output size
    async function resizeImageArrayBuffer(imgArrayBuffer, mime, maxDim=1600, quality=0.86){
      return new Promise((resolve, reject)=>{
        const blob = new Blob([imgArrayBuffer], {type:mime||'image/jpeg'});
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = async () => {
          let w = img.width, h = img.height;
          if (Math.max(w,h) <= maxDim){
            // no resize, return original buffer
            URL.revokeObjectURL(url);
            resolve(imgArrayBuffer);
            return;
          }
          const ratio = maxDim / Math.max(w,h);
          const cw = Math.round(w * ratio), ch = Math.round(h * ratio);
          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, cw, ch);
          canvas.toBlob(blobOut => {
            const fr = new FileReader();
            fr.onload = e => {
              URL.revokeObjectURL(url);
              resolve(e.target.result);
            };
            fr.onerror = err => {
              URL.revokeObjectURL(url);
              reject(err);
            };
            fr.readAsArrayBuffer(blobOut);
          }, mime || 'image/jpeg', quality);
        };
        img.onerror = e => {
          URL.revokeObjectURL(url);
          reject(e);
        };
        img.src = url;
      });
    }

    // Load MP3: read arrayBuffer and try to parse tags
    mp3FileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      if(f.type !== 'audio/mpeg' && !f.name.toLowerCase().endsWith('.mp3')){
        alert('Vui lòng chọn file MP3 hợp lệ.');
        mp3FileInput.value = '';
        return;
      }
      mp3File = f;
      setStatus('Đang đọc file MP3...');
      try {
        mp3ArrayBuffer = await readFileAsArrayBuffer(mp3File);
      } catch(err){
        setStatus('Không đọc được file MP3: ' + err, true);
        return;
      }

      // Read tags with jsmediatags (works on File object)
      jsmediatags.read(mp3File, {
        onSuccess: function(tag) {
          const tags = tag.tags || {};
          titleInput.value = tags.title || '';
          artistInput.value = (tags.artist || (Array.isArray(tags.performerInfo) ? tags.performerInfo.join(', ') : '')) ;
          albumInput.value = tags.album || '';
          yearInput.value = tags.year || '';
          genreInput.value = tags.genre || '';
          commentInput.value = (tags.comment && (tags.comment.text || tags.comment)) || '';

          // cover
          if (tags.picture && tags.picture.data) {
            const picture = tags.picture;
            const data = picture.data;
            const arr = new Uint8Array(data);
            // convert numeric array -> ArrayBuffer
            const buf = arr.buffer.slice(arr.byteOffset, arr.byteOffset + arr.byteLength);
            currentCoverArrayBuffer = buf;
            coverMime = picture.format || 'image/jpeg';
            coverPreview.src = arrayBufferToDataURL(buf, coverMime);
          } else {
            currentCoverArrayBuffer = null;
            coverMime = null;
            coverPreview.src = '';
            coverPreview.alt = 'No cover';
          }

          editorArea.style.display = 'block';
          applyBtn.disabled = false;
          previewBtn.disabled = false;
          setStatus('Đã đọc metadata. Bạn có thể chỉnh sửa và tải về.');
        },
        onError: function(error) {
          // still allow editing basic fields
          titleInput.value = '';
          artistInput.value = '';
          albumInput.value = '';
          yearInput.value = '';
          genreInput.value = '';
          commentInput.value = '';
          currentCoverArrayBuffer = null;
          coverPreview.src = '';
          editorArea.style.display = 'block';
          applyBtn.disabled = false;
          previewBtn.disabled = false;
          setStatus('Không tìm thấy ID3 tags (hoặc file có tags không đọc được). Bạn vẫn có thể thêm tags mới.');
          console.warn('jsmediatags error', error);
        }
      });

    });

    // Handle cover upload & preview + resize
    coverFileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      // Accept image types
      if(!f.type.startsWith('image/')) {
        alert('Vui lòng chọn file ảnh hợp lệ.');
        coverFileInput.value = '';
        return;
      }
      setStatus('Đang xử lý ảnh cover...');
      try {
        let imgBuf = await readFileAsArrayBuffer(f);
        // resize if too big (max 1600px)
        imgBuf = await resizeImageArrayBuffer(imgBuf, f.type, 1600, 0.86);
        currentCoverArrayBuffer = imgBuf;
        coverMime = f.type || 'image/jpeg';
        coverPreview.src = arrayBufferToDataURL(imgBuf, coverMime);
        setStatus('Ảnh cover đã sẵn sàng.');
      } catch(err){
        console.error(err);
        setStatus('Lỗi xử lý ảnh: ' + err, true);
      }
    });

    removeCoverBtn.addEventListener('click', () => {
      currentCoverArrayBuffer = null;
      coverMime = null;
      coverPreview.src = '';
      coverFileInput.value = '';
      setStatus('Ảnh cover đã bị xóa (sẽ không có cover sau khi lưu).');
    });

    previewBtn.addEventListener('click', () => {
      console.log('Preview tags to be written: ', {
        title: titleInput.value,
        artist: artistInput.value,
        album: albumInput.value,
        year: yearInput.value,
        genre: genreInput.value,
        comment: commentInput.value,
        hasCover: !!currentCoverArrayBuffer,
        coverMime
      });
      alert('Xem console (F12) để biết chi tiết preview tags.');
    });

    // Main: apply tags and produce new mp3 blob
    applyBtn.addEventListener('click', async () => {
      if(!mp3File || !mp3ArrayBuffer){
        alert('Chưa có file MP3. Vui lòng tải lên file MP3 trước.');
        return;
      }
      applyBtn.disabled = true;
      setStatus('Đang ghi tags vào file MP3 — xin chờ vài giây...');
      try {
        // Convert original file buffer to Uint8Array
        const uint8 = new Uint8Array(mp3ArrayBuffer);

        // Create writer (browser-id3-writer)
        const writer = new ID3Writer(uint8);

        // Set text frames (common frames)
        const title = titleInput.value || undefined;
        const artist = artistInput.value || undefined;
        const album = albumInput.value || undefined;
        const year = yearInput.value || undefined;
        const genre = genreInput.value || undefined;
        const comment = commentInput.value || undefined;

        if(title) writer.setFrame('TIT2', title);
        if(artist) writer.setFrame('TPE1', [artist]);
        if(album) writer.setFrame('TALB', album);
        if(year) writer.setFrame('TYER', year.toString());
        if(genre) writer.setFrame('TCON', genre);
        if(comment) writer.setFrame('COMM', {description: '', text: comment});

        // Cover: browser-id3-writer expects ArrayBuffer for data
        if(currentCoverArrayBuffer){
          // Ensure type is set
          writer.setFrame('APIC', {
            type: 3,
            data: new Uint8Array(currentCoverArrayBuffer),
            description: 'Cover (front)',
            mime: coverMime || 'image/jpeg'
          });
        } else {
          // If no cover selected, remove APIC by not setting it.
          // Note: browser-id3-writer doesn't offer remove frame; to remove, we'd need re-encode without APIC.
          // So if original had APIC, this will leave it as-is unless we explicitly overwrite with empty.
          // We'll attempt to overwrite APIC with empty data to remove:
          // (some players may still show old embedded if not removed properly)
          // For safety, do nothing here (most users will replace or keep).
        }

        // Commit tags
        writer.addTag();

        // Get Blob
        const taggedBlob = writer.getBlob();
        // Offer download
        const newName = mp3File.name.replace(/\.mp3$/i, '') + '-edited.mp3';
        const url = URL.createObjectURL(taggedBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = newName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus('Hoàn tất — file đã được tải xuống. Tên file: ' + newName);
      } catch(err){
        console.error('Error while writing tags', err);
        setStatus('Lỗi khi ghi tags: ' + err, true);
      } finally {
        applyBtn.disabled = false;
      }
    });

    // Helpful note in console
    console.log('MP3 ID3 Editor ready. Hướng dẫn ngắn: 1) Tải MP3 lên; 2) Sửa thông tin; 3) Thêm/Thay ảnh; 4) Nhấn "Áp dụng & Tải về".');
  </script>
</body>
</html>
